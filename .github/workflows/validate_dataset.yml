name: validate_dataset

on:
  push:
  pull_request:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install elan
        run: |
          curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
          echo "$HOME/.elan/bin" >> $GITHUB_PATH

      - name: Cache Lean toolchain and lake packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.elan
            lean/.lake
          key: ${{ runner.os }}-lean-${{ hashFiles('lean/lean-toolchain', 'lean/lakefile.lean') }}

      - name: Build Lean project
        run: |
          cd lean
          lake exe cache get || true
          lake build

      - name: Install harness
        run: python -m pip install -e harness

      - name: Validate pilot split
        run: |
          cd harness
          python -m autoform_eval.cli validate --split pilot

      - name: Assert pilot split count and validity
        run: |
          python - <<'PY'
          import json
          from pathlib import Path

          report_path = Path("dataset/validation_report.json")
          if not report_path.exists():
            raise SystemExit(f"missing validation report: {report_path}")
          report = json.loads(report_path.read_text(encoding="utf-8"))
          total = int(report.get("total", -1))
          invalid = int(report.get("invalid", -1))
          if total != 30:
            raise SystemExit(f"pilot row count drifted: expected 30, got {total}")
          if invalid != 0:
            raise SystemExit(f"pilot validation invalid count expected 0, got {invalid}")
          print(f"pilot validation summary ok: total={total}, invalid={invalid}")
          PY

      - name: Determinism smoke validate (mixed subset)
        run: |
          python - <<'PY'
          import json
          from pathlib import Path

          src = Path("dataset/pilot.jsonl")
          rows = [json.loads(line) for line in src.read_text(encoding="utf-8").splitlines() if line.strip()]
          keep = {
              "pilot_ring_001",
              "pilot_ring_003",
              "pilot_ring_005",
              "pilot_ring_007",
              "pilot_ring_010",
              "pilot_ring_012",
              "pilot_ring_014",
              "pilot_fintruth_001",
              "pilot_fintruth_003",
              "pilot_fintruth_005",
              "pilot_fintruth_007",
              "pilot_fintruth_010",
              "pilot_fintruth_013",
          }
          out_dir = Path("/tmp/auto_det_dataset")
          out_dir.mkdir(parents=True, exist_ok=True)
          selected = [r for r in rows if r["id"] in keep]
          (out_dir / "pilot.jsonl").write_text(
              "\\n".join(json.dumps(r, separators=(",", ":")) for r in selected) + "\\n",
              encoding="utf-8",
          )
          (out_dir / "dev.jsonl").write_text("", encoding="utf-8")
          (out_dir / "test.jsonl").write_text("", encoding="utf-8")
          print(f"determinism-smoke rows: {len(selected)}")
          PY

          cd harness
          python -m autoform_eval.cli validate \
            --split pilot \
            --dataset-dir /tmp/auto_det_dataset \
            --determinism-repeats 3 \
            --determinism-jitter-ms 5000

      - name: Validate dev split (schema and leakage checks)
        run: |
          cd harness
          python -m autoform_eval.cli validate --split dev --skip-lean

      - name: Validate test split (schema and leakage checks)
        run: |
          cd harness
          python -m autoform_eval.cli validate --split test --skip-lean

      - name: Validate dev split (Lean smoke subset)
        run: |
          python - <<'PY'
          import json
          from pathlib import Path

          src_dev = Path("dataset/dev.jsonl")
          rows = [json.loads(line) for line in src_dev.read_text(encoding="utf-8").splitlines() if line.strip()]
          keep = {
              "dev_ring_001",
              "dev_ring_003",
              "dev_ring_005",
              "dev_ring_007",
              "dev_fintruth_001",
              "dev_fintruth_003",
              "dev_fintruth_006",
              "dev_fintruth_009",
          }
          selected = [r for r in rows if r["id"] in keep]
          if len(selected) != len(keep):
            missing = sorted(keep - {r["id"] for r in selected})
            raise SystemExit(f"missing dev smoke ids: {missing}")

          out_dir = Path("/tmp/auto_dev_smoke")
          out_dir.mkdir(parents=True, exist_ok=True)
          (out_dir / "pilot.jsonl").write_text(Path("dataset/pilot.jsonl").read_text(encoding="utf-8"), encoding="utf-8")
          (out_dir / "dev.jsonl").write_text(
              "\\n".join(json.dumps(r, separators=(",", ":")) for r in selected) + "\\n",
              encoding="utf-8",
          )
          (out_dir / "test.jsonl").write_text(Path("dataset/test.jsonl").read_text(encoding="utf-8"), encoding="utf-8")
          print(f"dev-lean-smoke rows: {len(selected)}")
          PY

          cd harness
          python -m autoform_eval.cli validate \
            --split dev \
            --dataset-dir /tmp/auto_dev_smoke \
            --timeout1 12 \
            --timeout2 25
